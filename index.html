<!DOCTYPE html>
<html lang="is">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hjúkrunarheimili á Íslandi – Markaðsgreining</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; color: #1a2332; font-size: 14px; }

  /* Header */
  .header { background: linear-gradient(135deg, #0a1628 0%, #1a3a5c 60%, #1e5080 100%); color: white; padding: 28px 36px 22px; }
  .header h1 { font-size: 1.55rem; font-weight: 700; letter-spacing: -0.01em; }
  .header-sub { display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
  .badge { background: rgba(255,255,255,0.13); border: 1px solid rgba(255,255,255,0.22); padding: 3px 11px; border-radius: 20px; font-size: 0.73rem; color: rgba(255,255,255,0.85); }
  .badge.highlight { background: rgba(52,199,120,0.25); border-color: rgba(52,199,120,0.5); color: #7fffc4; }

  .container { max-width: 1600px; margin: 0 auto; padding: 24px 18px; }
  .two-col { display: grid; grid-template-columns: 1fr 300px; gap: 20px; align-items: start; }
  .main-col { min-width: 0; }
  .side-col { position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto; scrollbar-width: thin; scrollbar-color: #c8d3de transparent; }
  .side-col .ctrl-grid { grid-template-columns: 1fr !important; }
  .side-col .ctrl-col { border-right: none !important; border-bottom: 1px solid #f0f4f8; padding: 10px 0; }
  .side-col .ctrl-col:last-child { border-bottom: none; }
  .side-col .ctrl-row { flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
  .side-col .ctrl-row label { font-size: 0.75rem; width: 100%; }
  .side-col .ctrl-row input[type=range] { flex: 1; min-width: 80px; }
  .side-col .ctrl-val { min-width: 52px; }
  .side-col .flow-metrics { grid-template-columns: 1fr 1fr !important; gap: 10px; }
  @media (max-width: 1050px) { .two-col { grid-template-columns: 1fr; } .side-col { position: static; max-height: none; } }

  /* Section labels */
  .section-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: #8a9bb0; margin-bottom: 10px; margin-top: 4px; }

  /* KPI grid */
  .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(175px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .kpi { background: white; border-radius: 10px; padding: 16px 18px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); position: relative; overflow: hidden; }
  .kpi::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background: var(--accent, #1a3a5c); }
  .kpi.blue   { --accent: #1a6eb5; }
  .kpi.green  { --accent: #27ae60; }
  .kpi.orange { --accent: #e67e22; }
  .kpi.red    { --accent: #c0392b; }
  .kpi.purple { --accent: #7b2d8b; }
  .kpi.teal   { --accent: #0e8a7a; }
  .kpi label  { font-size: 0.68rem; color: #8a9bb0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; display: block; margin-bottom: 6px; }
  .kpi .val   { font-size: 1.85rem; font-weight: 700; line-height: 1; color: #0f1f35; }
  .kpi .sub   { font-size: 0.72rem; color: #9aacbc; margin-top: 5px; line-height: 1.3; }
  .kpi .trend { font-size: 0.75rem; font-weight: 600; }
  .kpi .trend.up   { color: #c0392b; }
  .kpi .trend.down { color: #27ae60; }

  /* Controls */
  .controls { background: white; border-radius: 10px; padding: 20px 24px; margin-bottom: 20px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); }
  .ctrl-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 0; }
  .ctrl-col { padding: 4px 16px; border-right: 1px solid #f0f4f8; }
  .ctrl-col:first-child { padding-left: 0; }
  .ctrl-col:last-child  { border-right: none; }
  .ctrl-col-title { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: #c0392b; margin-bottom: 12px; }
  .ctrl-col-title.blue   { color: #1a6eb5; }
  .ctrl-col-title.green  { color: #27ae60; }
  .ctrl-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
  .ctrl-row label { font-size: 0.8rem; font-weight: 500; color: #2c3e50; flex: 1; min-width: 160px; }
  .ctrl-row input[type=range] { width: 120px; accent-color: #1a3a5c; flex-shrink: 0; }
  .ctrl-val { font-size: 0.88rem; font-weight: 700; color: #1a3a5c; min-width: 70px; text-align: right; }

  /* Charts */
  .chart-full { background: white; border-radius: 10px; padding: 22px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); margin-bottom: 18px; }
  .chart-full h2 { font-size: 0.92rem; font-weight: 700; color: #0f1f35; margin-bottom: 3px; }
  .chart-full .chart-note { font-size: 0.72rem; color: #9aacbc; margin-bottom: 14px; line-height: 1.5; }
  .chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin-bottom: 18px; }
  .chart-box { background: white; border-radius: 10px; padding: 22px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); }
  .chart-box h2 { font-size: 0.92rem; font-weight: 700; color: #0f1f35; margin-bottom: 3px; }
  .chart-box .chart-note { font-size: 0.72rem; color: #9aacbc; margin-bottom: 14px; line-height: 1.5; }

  /* Insight box */
  .insight-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; margin-bottom: 18px; }
  .insight { background: white; border-radius: 10px; padding: 18px 20px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); border-left: 4px solid var(--c, #1a3a5c); }
  .insight.blue   { --c: #1a6eb5; }
  .insight.orange { --c: #e67e22; }
  .insight.green  { --c: #27ae60; }
  .insight.red    { --c: #c0392b; }
  .insight h3 { font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--c); margin-bottom: 8px; }
  .insight p { font-size: 0.82rem; color: #3a4f63; line-height: 1.55; }
  .insight strong { color: #0f1f35; }

  /* Table */
  .table-box { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 6px rgba(0,0,0,0.07); margin-bottom: 18px; overflow-x: auto; }
  .table-box h2 { font-size: 0.92rem; font-weight: 700; color: #0f1f35; margin-bottom: 14px; }
  table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
  thead th { background: #0f1f35; color: white; padding: 9px 12px; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
  td { padding: 8px 12px; border-bottom: 1px solid #f0f4f8; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f7fafd; }
  .eftir-aetlun { background: #fafbfc; color: #8a9bb0; font-style: italic; }
  .neg { color: #c0392b; font-weight: 700; }
  .pos { color: #27ae60; font-weight: 700; }
  .yr-badge { display: inline-block; background: #eef2f7; border-radius: 4px; padding: 1px 7px; font-weight: 700; font-size: 0.78rem; }

  /* Dvalartími box */
  .flow-box { background: linear-gradient(135deg, #0f1f35, #1a3a5c); color: white; border-radius: 10px; padding: 22px 26px; margin-bottom: 18px; }
  .flow-box h2 { font-size: 0.92rem; font-weight: 700; margin-bottom: 16px; opacity: 0.9; }
  .flow-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; }
  .flow-m { border-left: 2px solid rgba(255,255,255,0.2); padding-left: 14px; }
  .flow-m label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.55; display: block; margin-bottom: 4px; }
  .flow-m .fval { font-size: 1.5rem; font-weight: 700; line-height: 1; }
  .flow-m .fsub { font-size: 0.7rem; opacity: 0.5; margin-top: 3px; }

  @media (max-width: 800px) { .chart-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div class="header">
  <h1>Hjúkrunarheimili - Markaðsgreining ÍF (FEB 26)</h1>
  <div class="header-sub">
    <span class="badge">Mannfjöldagögn: Hagstofa Íslands MAN09010 (miðgildisspá)</span>
    <span class="badge">Framkvæmdaáætlun: Félags- og húsnæðismálaráðuneytið, feb 2026</span>
    <span class="badge highlight">Trúnaðarmál — til innri nota</span>
  </div>
</div>

<div class="container">
<div class="two-col">

<!-- ══ MAIN (LEFT) COLUMN ══ -->
<div class="main-col">

  <!-- ── SECTION 1: MARKET SIZE ── -->
  <div class="section-label">Lykiltölur</div>
  <div class="kpi-grid">
    <div class="kpi blue"><label>Rými í rekstri</label><div class="val">2,976</div><div class="sub">Sóltún viðmið 2025</div></div>
    <div class="kpi red"><label>Heildaþörf í dag</label><div class="val" id="kpi-demand-now">–</div><div class="sub" id="kpi-demand-sub">Þörfuhlutfall × mannfjöldi 67+</div></div>
    <div class="kpi orange"><label>Biðlisti</label><div class="val" id="kpi-waitlist">–</div><div class="sub">Staðfest þörf, án rýmis</div></div>
    <div class="kpi green"><label>Rýmavöntun — strax</label><div class="val" id="kpi-beds-now">–</div><div class="sub" id="kpi-beds-sub">Til að uppfylla markmiðsbiðtíma</div></div>
    <div class="kpi teal"><label>Innritanir á ári</label><div class="val" id="kpi-annual-admit">–</div><div class="sub">Rými × veltuhlutfall</div></div>
    <div class="kpi purple"><label>Reiknaður biðtími — 2025</label><div class="val" id="kpi-wait-time">–</div><div class="sub" id="kpi-wait-time-sub">dagar (markmið: 90 d.)</div></div>
  </div>

  <!-- ── STRATEGIC INSIGHTS ── -->
  <div class="section-label">Helstu niðurstöður</div>
  <div class="insight-grid">
    <div class="insight blue">
      <h3>Biðlistar</h3>
      <p id="insight-immediate">Loading...</p>
    </div>
    <div class="insight orange">
      <h3>Fjölgun aldraðra</h3>
      <p id="insight-growth">Loading...</p>
    </div>
    <div class="insight green">
      <h3>Nýbyggingar</h3>
      <p id="insight-build">Loading...</p>
    </div>
    <div class="insight red">
      <h3>Forsendur framkvæmdáætlunar</h3>
      <p id="insight-risk">Loading...</p>
    </div>
  </div>

  <!-- ── MAIN CHART ── -->
  <div class="chart-full">
    <h2>Framboð vs. Þörf — 2025 til 2040</h2>
    <div class="chart-note">Blár = framkvæmdaáætlun ríkis (til 2030), síðan spá um ný rými eftir 2030. Rauður = Vöntun. Appelsínugult strikað = markmið ríkisins (til 2030). Skyggða svæðið sýnir fjölda í þörf fyrir rými</div>
    <canvas id="mainChart" height="75"></canvas>
  </div>

  <!-- ── CHARTS ROW ── -->
  <div class="chart-grid">
    <div class="chart-box">
      <h2>Þróun biðlista 2026–2040</h2>
      <div class="chart-note">Byrjar á núverandi biðlista. Þróast eftir vexti þarfar að frádregnum nýjum rýmum. Grænt = minnkandi; rautt = vaxandi biðlisti.</div>
      <canvas id="waitChart" height="210"></canvas>
    </div>
    <div class="chart-box">
      <h2>Meðalbiðtími (spáður)</h2>
      <div class="chart-note">Biðlisti / (rými × veltuhlutfall / 365). Sýnir hvernig biðtími þróast — fer eftir dvalartíma og fjölda rýma. Rautt = yfir markmiðsbiðtíma.</div>
      <canvas id="waitTimeChart" height="210"></canvas>
    </div>
  </div>

  <div class="chart-grid">
    <div class="chart-box">
      <h2>Árleg markaðsflæði (innlagnir/ár)</h2>
      <div class="chart-note">Ný rými auka árslegar innlagnir. Þetta er rekstrarleg markaðsstærð — mikilvæg fyrir rekstraraðila, mannafla og tekjulíkön.</div>
      <canvas id="flowChart" height="210"></canvas>
    </div>
    <div class="chart-box">
      <h2>Þróun eldri íbúa (Hagstofa MAN09010)</h2>
      <div class="chart-note">Staflað súlurit — elsti hópur efst. Fjólublá lína (hægri ás) sýnir 67+ sem % af öllum landsmönnum. MAN00101 (2025) + MAN09010 miðgildisspá (2026–2040).</div>
      <canvas id="popChart" height="210"></canvas>
    </div>
  </div>

  <!-- ── DATA TABLE ── -->
  <div class="table-box">
    <h2>Árleg niðurstaða líkansins — 2025 til 2040</h2>
    <table>
      <thead>
        <tr>
          <th>Ár</th>
          <th>Framboð (rými)</th>
          <th>Þörf (líkan)</th>
          <th>Rýmavöntun</th>
          <th>Innritanir á ári</th>
          <th>Ný rými</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- ── PROJECTS TABLE ── -->
  <div class="table-box">
    <h2>Framkvæmdaáætlun — Stillanlegar afhendingardagsetningar</h2>
    <div class="chart-note" style="margin-bottom:12px;">
      Notaðu <strong>+/−</strong> til að seinka eða flýta hverju verkefni. Líkanið og gröfin uppfærast sjálfkrafa.
      <span style="margin-left:10px;"><span class="govt-badge">RÍKI</span> Opinber áætlun</span>
      <span style="margin-left:8px;"><span class="ppp-badge">PPP</span> Einkaaðilar / PPP — utan opinberrar áætlunar</span>
    </div>
    <table class="proj-table">
      <thead>
        <tr>
          <th>Áætlað ár</th>
          <th>Verkefni</th>
          <th>Landshluti</th>
          <th style="text-align:center">Rými</th>
          <th style="text-align:center">Leiðrétting</th>
          <th style="text-align:center">Raunverulegt ár</th>
        </tr>
      </thead>
      <tbody id="projectBody"></tbody>
    </table>
    <div style="margin-top:10px;font-size:0.78rem;color:#9aacbc;">
      * Hanið/lokið = staðfest í nýjustu gögnum Félags- og húsnæðismálaráðuneytisins (feb 2026) ·
      Keilisbraut 90 merktur sem óstaðfestur í gögnum ráðuneytisins
    </div>
  </div>


</div><!-- /main-col -->

<!-- ══ SIDEBAR (RIGHT) COLUMN ══ -->
<div class="side-col">
  <!-- ── CONTROLS ── -->
  <div class="controls">
    <div class="section-label" style="margin-bottom:14px;">Forsendur líkansins — stilltu til að kanna mismunandi sviðsmyndir</div>
    <div class="ctrl-grid">

      <div class="ctrl-col">
        <div class="ctrl-col-title red">Þörfuhlutfall eftir aldurshóp</div>
        <div class="ctrl-row">
          <label>Biðlisti 2025</label>
          <input type="range" id="waitInit" min="0" max="1200" step="50" value="650">
          <div class="ctrl-val" id="valWaitInit">650</div>
        </div>
        <div class="ctrl-row">
          <label>67–69 ára</label>
          <input type="range" id="rate6769" min="0" max="3" step="0.1" value="0.5">
          <div class="ctrl-val" id="valRate6769">0.5%</div>
        </div>
        <div class="ctrl-row">
          <label>70–79 ára</label>
          <input type="range" id="rate7079" min="0" max="10" step="0.5" value="3.0">
          <div class="ctrl-val" id="valRate7079">3.0%</div>
        </div>
        <div class="ctrl-row">
          <label>80–89 ára</label>
          <input type="range" id="rate8089" min="0" max="30" step="0.5" value="13.5">
          <div class="ctrl-val" id="valRate8089">13.5%</div>
        </div>
        <div class="ctrl-row">
          <label>90+ ára</label>
          <input type="range" id="rate90p" min="0" max="70" step="1" value="40">
          <div class="ctrl-val" id="valRate90p">40%</div>
        </div>
      </div>

      <div class="ctrl-col">
        <div class="ctrl-col-title blue">Dvalartími &amp; Markmið</div>
        <div class="ctrl-row">
          <label>Meðaldvöl hvers íbúa</label>
          <input type="range" id="stayMonths" min="6" max="36" step="1" value="20">
          <div class="ctrl-val" id="valStayMonths">20 mán.</div>
        </div>
        <div class="ctrl-row">
          <label>Markmiðsbiðtími ríkis</label>
          <input type="range" id="targetWait" min="30" max="365" step="15" value="90">
          <div class="ctrl-val" id="valTargetWait">90 dagar</div>
        </div>
        <div style="font-size:0.68rem;color:#9aacbc;margin-top:4px;line-height:1.4;">
          Reiknaður biðtími er <em>úttak</em> líkansins — ekki inntaksforsenda
        </div>
      </div>

      <div class="ctrl-col">
        <div class="ctrl-col-title green">Framboð eftir 2030</div>
        <div class="ctrl-row">
          <label>Ný rými/ár eftir 2030</label>
          <input type="range" id="postBuild" min="0" max="200" step="10" value="100">
          <div class="ctrl-val" id="valPostBuild">100/ár</div>
        </div>
      </div>

    </div>
  </div>

  <!-- ── FLOW MECHANICS ── -->
  <div class="flow-box">
    <h2>Flæðigreining</h2>
    <div class="flow-metrics">
      <div class="flow-m"><label>Meðaldvöl</label><div class="fval" id="fm-stay">–</div><div class="fsub">Mánuðir á rými</div></div>
      <div class="flow-m"><label>Veltuhlutfall</label><div class="fval" id="fm-turnover">–</div><div class="fsub">Innrit á ári per rými</div></div>
      <div class="flow-m"><label>Innritanir á ári</label><div class="fval" id="fm-admissions">–</div><div class="fsub">Við 2.976 rými</div></div>
      <div class="flow-m"><label>Rýmavöntun 2030</label><div class="fval" id="fm-gap2030">–</div><div class="fsub">Þörf − framboð</div></div>
      <div class="flow-m"><label>Rýmavöntun 2040</label><div class="fval" id="fm-gap2040">–</div><div class="fsub">Þörf − framboð</div></div>
      <div class="flow-m"><label>Rýmavöntun í dag</label><div class="fval" id="fm-backlog">–</div><div class="fsub" id="fm-backlog-sub">Þörf − framboð 2025</div></div>
    </div>
  </div>


</div><!-- /side-col -->

</div><!-- /two-col -->
</div><!-- /container -->

<script>
// ── STATIC DATA ───────────────────────────────────────────────────────────────
const YEARS = [2025,2026,2027,2028,2029,2030,2031,2032,2033,2034,2035,2036,2037,2038,2039,2040];

const POP_6769 = {2025:11322,2026:11526,2027:11647,2028:11604,2029:11588,2030:11588,2031:11700,2032:11979,2033:12045,2034:12142,2035:12058,2036:11895,2037:11710,2038:11643,2039:11942,2040:12586};
const POP_7079 = {2025:28110,2026:29223,2027:30272,2028:31277,2029:31945,2030:32743,2031:33384,2032:33842,2033:34440,2034:34935,2035:35402,2036:35718,2037:36038,2038:36070,2039:36163,2040:36191};
const POP_8089 = {2025:11713,2026:12567,2027:13203,2028:13976,2029:14852,2030:15686,2031:16558,2032:17361,2033:18061,2034:18865,2035:19604,2036:20342,2037:21144,2038:21943,2039:22475,2040:23115};
const POP_90P  = {2025:2497, 2026:2586, 2027:2650, 2028:2704, 2029:2734, 2030:2804, 2031:2900, 2032:3022, 2033:3221, 2034:3435, 2035:3666, 2036:3949, 2037:4203, 2038:4503, 2039:4829, 2040:5132};
const BEDS_2025 = 2976;

const PROJECTS = [
  {name:"Urðarhvarf",       region:"Höfuðborgarsvæðið", rooms:100, year:2026, type:"confirmed"},
  {name:"Nesvellir",        region:"Suðurnesja",          rooms: 50, year:2026, type:"confirmed"},
  {name:"Ísafold",          region:"Höfuðborgarsvæðið", rooms:  4, year:2026, type:"confirmed"},
  {name:"Hamranes",         region:"Höfuðborgarsvæðið", rooms: 99, year:2026, type:"ppp"},
  {name:"Sóltún RVK",       region:"Höfuðborgarsvæðið", rooms: 67, year:2027, type:"confirmed"},
  {name:"Keilisbraut",      region:"Suðurnesja",          rooms: 90, year:2027, type:"planned"},
  {name:"Húsavík",          region:"Norðurland",           rooms:  6, year:2027, type:"confirmed"},
  {name:"Nauthólsvegur",    region:"Höfuðborgarsvæðið", rooms: 87, year:2027, type:"confirmed"},
  {name:"Hveragerði",       region:"Suðurland",            rooms: 26, year:2027, type:"confirmed"},
  {name:"Höfn",             region:"Austurland",           rooms:  6, year:2027, type:"confirmed"},
  {name:"Þursaholt",        region:"Norðurland",           rooms:140, year:2028, type:"planned"},
  {name:"Mosfellsbær",      region:"Höfuðborgarsvæðið", rooms: 66, year:2028, type:"planned"},
  {name:"Akranes",          region:"Vesturland",           rooms: 60, year:2028, type:"planned"},
  {name:"Hraunvangur",      region:"Höfuðborgarsvæðið", rooms:125, year:2028, type:"planned"},
  {name:"Eir Grafarvogur",  region:"Höfuðborgarsvæðið", rooms: 60, year:2028, type:"planned"},
  {name:"Vigdísarholt",     region:"Höfuðborgarsvæðið", rooms:108, year:2029, type:"ppp"},
  {name:"Eyri",             region:"Austurland",           rooms: 20, year:2029, type:"planned"},
  {name:"Vetrarmýri",       region:"Höfuðborgarsvæðið", rooms:100, year:2029, type:"planned"},
  {name:"Reykjavík (ógr.)", region:"Höfuðborgarsvæðið", rooms:100, year:2029, type:"planned"},
  {name:"Patreksfjörður",   region:"Vestfjarðar",          rooms:  0, year:2029, type:"planned"},
  {name:"Vík í Mýrdal",    region:"Suðurland",            rooms:  0, year:2029, type:"planned"},
  {name:"Austurland (ógr.)",region:"Austurland",           rooms: 20, year:2030, type:"planned"},
  {name:"Suðurland (ógr.)", region:"Suðurland",            rooms: 40, year:2030, type:"planned"},
  {name:"Óákveðið",         region:"Höfuðborgarsvæðið", rooms: 80, year:2030, type:"planned"},
];

// ── STATE ─────────────────────────────────────────────────────────────────────
let adjustments = PROJECTS.map(() => 0);
let waitInit   = 650;
let rate6769   = 0.5;
let rate7079   = 3.0;
let rate8089   = 13.5;
let rate90p    = 40.0;
let stayMonths = 20;
let targetWait = 90;
let postBuild  = 100;

// ── CORE MODEL ────────────────────────────────────────────────────────────────
function effYear(i) { return PROJECTS[i].year + adjustments[i]; }

function getSupply(y) {
  let total = BEDS_2025;
  PROJECTS.forEach((p, i) => { if (p.rooms > 0 && effYear(i) <= y) total += p.rooms; });
  if (y > 2030) total += (y - 2030) * postBuild;
  return total;
}

// Stock demand = rooms needed at any moment
// KPMG rates calibrated at 20 month baseline stay.
// Longer stays → more rooms occupied simultaneously → higher demand
const STAY_BASELINE = 20;
function getDemandStock(y) {
  const base = (POP_6769[y]||0)*rate6769/100 + (POP_7079[y]||0)*rate7079/100 +
               (POP_8089[y]||0)*rate8089/100 + (POP_90P[y]||0)*rate90p/100;
  return Math.round(base * stayMonths / STAY_BASELINE);
}

// For main supply/demand chart: stock demand (rooms needed by population)
function getDemand(y) {
  // Stock need + waitlist component (scaled by pop growth from 2025)
  const popGrowth = ((POP_6769[y]||0)+(POP_7079[y]||0)+(POP_8089[y]||0)+(POP_90P[y]||0)) /
                    (POP_6769[2025]+POP_7079[2025]+POP_8089[2025]+POP_90P[2025]);
  return getDemandStock(y) + Math.round(waitInit * popGrowth);
}
function getGap(y) { return getRoomGap(y); }

// Structural room gap (does not depend on stayMonths)
function getRoomGap(y) { return getDemandStock(y) - getSupply(y); }

function turnoverRate()         { return 12 / stayMonths; }
function annualAdmissions(beds) { return Math.round(beds * turnoverRate()); }

// Flow model: waitlist evolves year by year
// Each year: net_change = (demand_stock - supply) × turnover_rate
// = structural_gap × turnover — so stayMonths directly drives waitlist speed
function computeWaitlist() {
  const wl = {};
  // 2025 starting waitlist = structural room gap + known waitlisted (slider)
  let current = Math.max(0, getRoomGap(2025)) + waitInit;
  wl[2025] = current;
  for (let y = 2026; y <= 2040; y++) {
    const delta = Math.round(getRoomGap(y) * turnoverRate());
    current = Math.max(0, current + delta);
    wl[y] = current;
  }
  return wl;
}

// Cached waitlist — rebuilt on every renderAll
let _waitlist = null;
function getWaitlist(y) {
  if (!_waitlist) _waitlist = computeWaitlist();
  return _waitlist[y] ?? 0;
}

function calcWaitDays(y) {
  const wl = getWaitlist(y);
  if (wl <= 0) return 0;
  return Math.round(wl / (getSupply(y) * turnoverRate() / 365));
}

function bedsNeededNow() { return Math.max(0, getRoomGap(2025)); }

const fmt     = n => Math.round(n).toLocaleString('is-IS');
const fmtSign = n => (n >= 0 ? '+' : '') + fmt(n);

// ── UPDATE KPIs & INSIGHTS ────────────────────────────────────────────────────
function updateKPIs() {
  const d25   = getDemand(2025), wt25 = calcWaitDays(2025);
  const admit = annualAdmissions(BEDS_2025);
  const bNow  = bedsNeededNow();
  const adjCount = adjustments.filter(a=>a!==0).length;

  document.getElementById('kpi-demand-now').textContent = fmt(d25);
  document.getElementById('kpi-waitlist').textContent    = fmt(getWaitlist(2025));
  document.getElementById('kpi-demand-sub').textContent =
    '67-69: '+fmt(Math.round((POP_6769[2025]||0)*rate6769/100))+
    ' · 70-79: '+fmt(Math.round((POP_7079[2025]||0)*rate7079/100))+
    ' · 80-89: '+fmt(Math.round((POP_8089[2025]||0)*rate8089/100))+
    ' · 90+: '+fmt(Math.round((POP_90P[2025]||0)*rate90p/100))+
    ' · Biðlisti: '+fmt(waitInit);
  document.getElementById('kpi-wait-time').textContent     = wt25 > 0 ? fmt(wt25) : '0';
  document.getElementById('kpi-wait-time-sub').textContent = 'dagar — markmið: '+targetWait+' d.';
  document.getElementById('kpi-beds-now').textContent      = fmt(bNow);
  document.getElementById('kpi-beds-sub').textContent      = 'Bil á milli þarfar og framboðs';
  document.getElementById('kpi-annual-admit').textContent  = fmt(admit);

  document.getElementById('fm-stay').textContent        = stayMonths+' mán.';
  document.getElementById('fm-turnover').textContent    = turnoverRate().toFixed(2)+'×';
  document.getElementById('fm-admissions').textContent  = fmt(admit);
  const wl2030 = getWaitlist(2030), wl2040 = getWaitlist(2040);
  document.getElementById('fm-gap2030').textContent     = fmt(wl2030);
  document.getElementById('fm-gap2040').textContent     = fmt(wl2040);
  document.getElementById('fm-backlog').textContent     = fmt(waitInit);
  document.getElementById('fm-backlog-sub').textContent = 'Upphafsstærð biðlista 2025';
  document.getElementById('fm-gap2030').style.color     = wl2030>300 ? '#c0392b' : wl2030>0 ? '#e67e22' : '#27ae60';
  document.getElementById('fm-gap2040').style.color     = wl2040>300 ? '#c0392b' : wl2040>0 ? '#e67e22' : '#27ae60';

  document.getElementById('insight-immediate').innerHTML =
    `Heildaþörf 2025 er <strong>${fmt(d25)} rými</strong>. `+
    `Rýmavöntun (rými): <strong>${fmt(bNow)}</strong>. `+
    `Biðlisti 2025: <strong>${fmt(waitInit)}</strong> einstaklingar. `+
    `Reiknaður biðtími: <strong>${fmt(wt25)} dagar</strong>.`;

  document.getElementById('insight-growth').innerHTML =
    `90+ hópurinn tvöfaldast — úr <strong>${fmt(POP_90P[2025])}</strong> (2025) í <strong>${fmt(POP_90P[2040])}</strong> (2040). `+
    `Heildaþörf hækkar úr <strong>${fmt(d25)}</strong> í <strong>${fmt(getDemand(2040))}</strong>. `+
    `Biðlisti: ${fmt(getWaitlist(2030))} (2030) → <strong>${fmt(getWaitlist(2040))} (2040)</strong>.`;

  document.getElementById('insight-build').innerHTML =
    `Framkvæmdaáætlun gefur <strong>${fmt(getSupply(2030))} rými</strong> árið 2030`+
    (adjCount>0 ? ` (${adjCount} verkefni með leiðréttingu)` : '')+`. `+
    `Biðlisti 2030: <strong>${fmt(getWaitlist(2030))}</strong> · `+
    `Biðlisti 2040: <strong>${fmt(getWaitlist(2040))}</strong> (við ${postBuild} rými/ár eftir 2030).`;

  document.getElementById('insight-risk').innerHTML =
    `Hlutföllin ${rate6769}% / ${rate7079}% / ${rate8089}% / ${rate90p}% eru sömu forsendur og KPMG notar. `+
    `Biðlisti þróast með flæðilíkani: (rýmavöntun × veltuhlutfall) bætist við á hverju ári. `+
    `Styttri dvalartími → hraðari velting → biðlisti minnkar hraðar. `+
    `Reiknaður biðtími <strong>${fmt(wt25)} dagar</strong> 2025.`;
}

// ── PROJECT TABLE ─────────────────────────────────────────────────────────────
function buildProjectTable() {
  const tbody = document.getElementById('projectBody');
  const effYearMap = {};
  PROJECTS.forEach((p,i) => {
    const ey = effYear(i);
    if (!effYearMap[ey]) effYearMap[ey] = [];
    effYearMap[ey].push({...p, i});
  });
  const sortedYears = Object.keys(effYearMap).map(Number).sort();
  let html = '';

  sortedYears.forEach(ey => {
    const group = effYearMap[ey];
    const supplyEOY = getSupply(ey);
    const addedThisYear = group.reduce((s,p) => s+(p.rooms||0), 0);
    html += `<tr class="proj-year-group">
      <td colspan="4"><strong>${ey}</strong> — Framboð í árslok: <strong>${fmt(supplyEOY)}</strong></td>
      <td colspan="2" style="text-align:right">Viðbót þetta ár: <strong>+${fmt(addedThisYear)}</strong></td>
    </tr>`;
    group.forEach(p => {
      const adj = adjustments[p.i];
      const eyClass = adj>0?'delayed':adj<0?'early':'ontime';
      const eyLabel = adj>0?`${ey} ⚠`:adj<0?`${ey} ↑`:`${ey}`;
      const adjLabel = adj===0?'0':adj>0?`+${adj}`:`${adj}`;
      const adjClass = adj>0?'positive':adj<0?'negative':'';
      const isPPP = p.type==='ppp';
      const badge = isPPP
        ? `<span class="ppp-badge">PPP</span>`
        : (p.type==='confirmed'
            ? `<span class="govt-badge" style="background:#27ae60">✓</span>`
            : `<span class="govt-badge">RÍKI</span>`);
      const origNote = adj!==0 ? `<span style="font-size:0.68rem;color:#9aacbc"> (áætl. ${p.year})</span>` : '';
      html += `<tr class="${isPPP?'ppp-row':''}">
        <td><span class="yr-badge">${p.year}</span></td>
        <td>${p.name}${badge}${origNote}</td>
        <td style="color:#666;font-size:0.78rem">${p.region}</td>
        <td class="rooms-cell" style="text-align:center">${p.rooms>0?'+'+p.rooms:'—'}</td>
        <td><div class="adj-cell">
          <button class="adj-btn" onclick="adjust(${p.i},+1)" title="Seinka um 1 ár">+</button>
          <span class="adj-display ${adjClass}">${adjLabel}y</span>
          <button class="adj-btn" onclick="adjust(${p.i},-1)" title="Flýta um 1 ár">−</button>
        </div></td>
        <td><span class="eff-year ${eyClass}">${eyLabel}</span></td>
      </tr>`;
    });
  });

  const totalRooms = PROJECTS.reduce((s,p)=>s+p.rooms,0);
  const govtRooms  = PROJECTS.filter(p=>p.type!=='ppp').reduce((s,p)=>s+p.rooms,0);
  const pppRooms   = PROJECTS.filter(p=>p.type==='ppp').reduce((s,p)=>s+p.rooms,0);
  html += `<tr class="proj-grand">
    <td colspan="3"><strong>Heildarsumma 2026–2030</strong></td>
    <td style="text-align:center;color:white"><strong>+${fmt(totalRooms)}</strong></td>
    <td colspan="2" style="color:#adc8e0;font-size:0.78rem">Ríki: +${fmt(govtRooms)} · PPP: +${fmt(pppRooms)}</td>
  </tr>`;
  tbody.innerHTML = html;
}

function adjust(idx, delta) {
  const n = adjustments[idx] + delta;
  if (n < -3 || n > 7) return;
  adjustments[idx] = n;
  renderAll();
}

// ── CHARTS ────────────────────────────────────────────────────────────────────
let mainChart, waitChart, waitTimeChart, flowChart, popChart;

function buildMainChart() {
  const demand = YEARS.map(y=>getDemand(y));
  const supply = YEARS.map(y=>getSupply(y));
  const gap    = YEARS.map((y,i)=>Math.max(0,demand[i]-supply[i]));
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (mainChart) mainChart.destroy();
  mainChart = new Chart(ctx, {
    data:{labels:YEARS, datasets:[
      {type:'bar',  label:'Rýmavöntun', data:gap, backgroundColor:'rgba(192,57,43,0.15)', borderColor:'rgba(192,57,43,0.3)', borderWidth:1},
      {type:'line', label:'Framboð (rými)', data:supply, borderColor:'#1a6eb5', backgroundColor:'rgba(26,110,181,0.06)', borderWidth:2.5, pointRadius:4, fill:false, tension:0.15},
      {type:'line', label:'Þörf (4 aldurshópar + biðlisti)', data:demand, borderColor:'#c0392b', borderWidth:2.5, pointRadius:4, fill:false, tension:0.15},
    ]},
    options:{responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{legend:{position:'bottom',labels:{boxWidth:13,font:{size:11}}},
        tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${c.raw!=null?fmt(c.raw):'—'}`}}},
      scales:{y:{min:0,
        suggestedMax: Math.ceil(Math.max(...YEARS.filter(y=>y<=2032).map(y=>getDemand(y))) / 500) * 500,
        title:{display:true,text:'Rými'},ticks:{callback:v=>fmt(v)},grid:{color:'#f5f7fa'}},
              x:{grid:{color:'#f5f7fa'}}}}
  });
}

function buildWaitChart() {
  const data   = YEARS.map(y => getWaitlist(y));
  const colors = data.map(v=>v>800?'rgba(192,57,43,0.7)':v>300?'rgba(230,126,34,0.7)':'rgba(39,174,96,0.7)');
  const ctx = document.getElementById('waitChart').getContext('2d');
  if (waitChart) waitChart.destroy();
  waitChart = new Chart(ctx, {
    type:'bar',
    data:{labels:YEARS, datasets:[{label:'Biðlisti (einstaklingar)', data, backgroundColor:colors, borderWidth:0}]},
    options:{responsive:true, plugins:{legend:{display:false},
        tooltip:{callbacks:{label:c=>`Biðlisti: ${fmt(c.raw)} einstaklingar`}}},
      scales:{y:{beginAtZero:true,
        suggestedMax: Math.ceil(Math.max(...YEARS.filter(y=>y<=2032).map(y=>getWaitlist(y))) / 200) * 200,
        title:{display:true,text:'Einstaklingar á biðlista'},ticks:{callback:v=>fmt(v)},grid:{color:'#f5f7fa'}},
              x:{grid:{color:'#f5f7fa'}}}}
  });
}

function buildWaitTimeChart() {
  const data   = YEARS.map(y=>calcWaitDays(y)); // uses waitlist flow model
  const target = YEARS.map(()=>targetWait);
  const colors = data.map(v=>v>targetWait?'rgba(192,57,43,0.65)':v>0?'rgba(230,126,34,0.65)':'rgba(39,174,96,0.65)');
  const ctx = document.getElementById('waitTimeChart').getContext('2d');
  if (waitTimeChart) waitTimeChart.destroy();
  waitTimeChart = new Chart(ctx, {
    data:{labels:YEARS, datasets:[
      {type:'bar',  label:'Reiknaður biðtími (dagar)', data, backgroundColor:colors, borderWidth:0},
      {type:'line', label:'Markmiðsbiðtími', data:target, borderColor:'#e67e22', borderDash:[5,4], borderWidth:2, pointRadius:0, fill:false},
    ]},
    options:{responsive:true,
      plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}},
        tooltip:{callbacks:{label:c=>`${c.dataset.label}: ${fmt(c.raw)} dagar`}}},
      scales:{y:{beginAtZero:true,title:{display:true,text:'Dagar'},ticks:{callback:v=>fmt(v)},grid:{color:'#f5f7fa'}},
              x:{grid:{color:'#f5f7fa'}}}}
  });
}

function buildFlowChart() {
  const ctx = document.getElementById('flowChart').getContext('2d');
  if (flowChart) flowChart.destroy();
  flowChart = new Chart(ctx, {
    type:'line',
    data:{labels:YEARS, datasets:[{
      label:'Innritanir á ári (rými × veltuhlutfall)',
      data:YEARS.map(y=>annualAdmissions(getSupply(y))),
      borderColor:'#0e8a7a', backgroundColor:'rgba(14,138,122,0.1)', fill:true, borderWidth:2.5, tension:0.3, pointRadius:4
    }]},
    options:{responsive:true, plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}}},
      scales:{y:{beginAtZero:false,title:{display:true,text:'Innritanir á ári'},ticks:{callback:v=>fmt(v)},grid:{color:'#f5f7fa'}},
              x:{grid:{color:'#f5f7fa'}}}}
  });
}

function buildPopChart() {
  const totalPop = {2025:380000,2026:390000,2027:400000,2028:408000,2029:416000,2030:424000,
    2031:431000,2032:438000,2033:445000,2034:452000,2035:458000,2036:463000,2037:468000,2038:473000,2039:477000,2040:481000};
  const pct67p = YEARS.map(y => {
    const pop67 = (POP_6769[y]||0)+(POP_7079[y]||0)+(POP_8089[y]||0)+(POP_90P[y]||0);
    return +((pop67/totalPop[y])*100).toFixed(1);
  });
  const ctx = document.getElementById('popChart').getContext('2d');
  if (popChart) popChart.destroy();
  popChart = new Chart(ctx, {
    data:{labels:YEARS, datasets:[
      {type:'bar', label:'67–69 ára', data:YEARS.map(y=>POP_6769[y]), backgroundColor:'rgba(14,138,122,0.7)', stack:'pop'},
      {type:'bar', label:'70–79 ára', data:YEARS.map(y=>POP_7079[y]), backgroundColor:'rgba(26,110,181,0.7)', stack:'pop'},
      {type:'bar', label:'80–89 ára', data:YEARS.map(y=>POP_8089[y]), backgroundColor:'rgba(230,126,34,0.8)', stack:'pop'},
      {type:'bar', label:'90+ ára',   data:YEARS.map(y=>POP_90P[y]),  backgroundColor:'rgba(192,57,43,0.85)', stack:'pop'},
      {type:'line', label:'% af þjóðinni (67+)', data:pct67p,
       borderColor:'#8e44ad', backgroundColor:'transparent', borderWidth:2.5, pointRadius:4,
       pointBackgroundColor:'#8e44ad', fill:false, tension:0.3, yAxisID:'y2'},
    ]},
    options:{responsive:true,
      plugins:{legend:{position:'bottom',labels:{boxWidth:12,font:{size:11}}},
        tooltip:{callbacks:{label:c=>c.dataset.yAxisID==='y2'?`${c.dataset.label}: ${c.raw}%`:`${c.dataset.label}: ${fmt(c.raw)}`}}},
      scales:{
        y:{stacked:true,title:{display:true,text:'Mannfjöldi (67+)'},ticks:{callback:v=>fmt(v)},grid:{color:'#f5f7fa'}},
        y2:{position:'right',title:{display:true,text:'% af þjóðinni'},min:10,max:25,ticks:{callback:v=>v+'%'},grid:{drawOnChartArea:false}},
        x:{grid:{color:'#f5f7fa'}}
      }
    }
  });
}

// ── DATA TABLE ────────────────────────────────────────────────────────────────
function buildTable() {
  let prev = null;
  document.getElementById('tableBody').innerHTML = YEARS.map(y => {
    const s   = getSupply(y), d = getDemand(y), gap = getGap(y);
    const added = prev !== null ? s - prev : 0;
    prev = s;
    const isPost = y > 2030;
    const gapClass = gap>0?'neg':'pos';
    return `<tr class="${isPost?'eftir-aetlun':''}">
      <td><span class="yr-badge">${y}</span>${isPost?' <span style="font-size:0.68rem;color:#9aacbc">eftir áætlun</span>':''}</td>
      <td>${fmt(s)}</td>
      <td>${fmt(d)}</td>
      <td class="${gapClass}" style="font-weight:700">${gap>0?fmt(gap):'—'}</td>
      <td>${fmt(annualAdmissions(s))}</td>
      <td style="color:#1a6eb5;font-weight:${added>0?'600':'400'}">${added>0?'+'+fmt(added):'—'}</td>
    </tr>`;
  }).join('');
}

// ── RENDER ────────────────────────────────────────────────────────────────────
function renderAll() {
  _waitlist = null; // invalidate cache
  updateKPIs();
  buildMainChart();
  buildWaitChart();
  buildWaitTimeChart();
  buildFlowChart();
  buildTable();
  buildProjectTable();
}

// ── SLIDERS ───────────────────────────────────────────────────────────────────
[
  ['waitInit',   v => { waitInit   = parseInt(v);   return Math.round(v).toLocaleString('is-IS'); }],
  ['rate6769',   v => { rate6769   = parseFloat(v); return v+'%'; }],
  ['rate7079',   v => { rate7079   = parseFloat(v); return v+'%'; }],
  ['rate8089',   v => { rate8089   = parseFloat(v); return v+'%'; }],
  ['rate90p',    v => { rate90p    = parseFloat(v); return v+'%'; }],
  ['stayMonths', v => { stayMonths = parseInt(v);   return v+' mán.'; }],
  ['targetWait', v => { targetWait = parseInt(v);   return v+' dagar'; }],
  ['postBuild',  v => { postBuild  = parseInt(v);   return v+'/ár'; }],
].forEach(([id, fn]) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', function() {
    const display = fn(this.value);
    const valEl = document.getElementById('val'+id.charAt(0).toUpperCase()+id.slice(1));
    if (valEl) valEl.textContent = display;
    renderAll();
  });
});

// ── INIT ──────────────────────────────────────────────────────────────────────
renderAll();
buildPopChart();
</script>
</body>
</html>
